using System;
using System.Linq;
using System.Collections.Generic;
using System.Runtime.InteropServices;
using System.Runtime.CompilerServices;
using UnityEngine;
using Cycling74.RNBOTypes;

//TODO how to share these aliases?
//https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/built-in-types
using Float = System.Double;
using MillisecondTime = System.Double;
using ParameterValue = System.Double;
using ParameterIndex = System.UIntPtr;
using MessageTag = System.UInt32;

public class ${PLUGIN_NAME_ID}Handle {
    public event EventHandler<ParameterChangedEventArgs> ParameterChangedEvent;
    public event EventHandler<MessageEventArgs> MessageEvent;
    public event EventHandler<TransportEventArgs> TransportEvent;
    public event EventHandler<TempoEventArgs> TempoEvent;
    public event EventHandler<BeatTimeEventArgs> BeatTimeEvent;
    public event EventHandler<TimeSignatureEventArgs> TimeSignatureEvent;

    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate void ReleaseDataRefDelegate(UIntPtr id);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern IntPtr RNBOInstanceCreate(out int key);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern void RNBOInstanceDestroy(IntPtr instance);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern void RNBOProcess(IntPtr instance, MillisecondTime now, float[] data, int channels, int nframes, int samplerate);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern MessageTag RNBOTag(IntPtr tagString);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern IntPtr RNBOGetDescription();

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern IntPtr RNBOGetPresets();

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOResolveTag(int key, MessageTag tag, out IntPtr tagStr);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOInstanceMapped(int key);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOPoll(int key);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOSetParamValue(int key, ParameterIndex index, ParameterValue value, MillisecondTime attime);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOGetParamValue(int key, ParameterIndex index, out ParameterValue value);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOSetParamValueNormalized(int key, ParameterIndex index, ParameterValue value, MillisecondTime attime);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOGetParamValueNormalized(int key, ParameterIndex index, out ParameterValue value);

    [DllImport("${PLUGIN_NAME_ID}", CallingConvention = CallingConvention.StdCall)]
    private static extern bool RNBORegisterParameterEventCallback(int key, IntPtr callback);

    [DllImport("${PLUGIN_NAME_ID}", CallingConvention = CallingConvention.StdCall)]
    private static extern bool RNBORegisterMessageEventCallback(int key, IntPtr callback);

    [DllImport("${PLUGIN_NAME_ID}", CallingConvention = CallingConvention.StdCall)]
    private static extern bool RNBORegisterTransportEventCallback(int key, IntPtr callback);

    [DllImport("${PLUGIN_NAME_ID}", CallingConvention = CallingConvention.StdCall)]
    private static extern bool RNBORegisterTempoEventCallback(int key, IntPtr callback);

    [DllImport("${PLUGIN_NAME_ID}", CallingConvention = CallingConvention.StdCall)]
    private static extern bool RNBORegisterBeatTimeEventCallback(int key, IntPtr callback);

    [DllImport("${PLUGIN_NAME_ID}", CallingConvention = CallingConvention.StdCall)]
    private static extern bool RNBORegisterTimeSignatureEventCallback(int key, IntPtr callback);

    [DllImport("${PLUGIN_NAME_ID}", CallingConvention = CallingConvention.StdCall)]
    private static extern bool RNBORegisterGlobalTransportRequestCallback(IntPtr callback);

    [DllImport("${PLUGIN_NAME_ID}", CallingConvention = CallingConvention.StdCall)]
    private static extern bool RNBORegisterTransportRequestCallback(int key, IntPtr callback);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOSendMessageBang(int key, MessageTag tag, MillisecondTime atTime);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOSendMessageNumber(int key, MessageTag tag, Float value, MillisecondTime atTime);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOSendMessageList(int key, MessageTag tag, [MarshalAs(UnmanagedType.LPArray)] Float[] list, IntPtr listlen, MillisecondTime atTime);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOSendMIDI(int key, [MarshalAs(UnmanagedType.LPArray)] byte[] data, IntPtr dataLen, MillisecondTime atTime);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOSendTransportEvent(int key, bool running, MillisecondTime atTime);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOSendTempoEvent(int key, Float bpm, MillisecondTime atTime);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOSendBeatTimeEvent(int key, Float beattime, MillisecondTime atTime);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOSendTimeSignatureEvent(int key, int numerator, int denominator, MillisecondTime atTime);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOCopyLoadDataRef(int key, IntPtr id, [MarshalAs(UnmanagedType.LPArray)] System.Single[] data, IntPtr datalen, IntPtr channels, IntPtr samplerate);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOReleaseDataRef(int key, IntPtr id);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOLoadPreset(int key, IntPtr payload);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern bool RNBOGetPresetSync(int key, out IntPtr payloadPtr);

    [DllImport("${PLUGIN_NAME_ID}")]
    private static extern void RNBOFreePreset(IntPtr payloadPtr);


    private static PatcherDescription patcherDescription;
    public static PatcherDescription PatcherDescription {
        get {
            if (patcherDescription == null) {
                string descString = Marshal.PtrToStringAnsi(RNBOGetDescription());
                patcherDescription = JsonUtility.FromJson<PatcherDescription>(descString)!;
            }
            return patcherDescription;
        }
    }

    private static ParameterInfo[] parameters;
    public static ParameterInfo[] Parameters {
        get {
            if (parameters == null) {
                parameters = PatcherDescription.parameters.ToArray();
            }
            return parameters;
        }
    }

    private static Port[] inports;
    public static Port[] Inports {
        get {
            if (inports == null) {
                inports = PatcherDescription.inports.ToArray();
            }
            return inports;
        }
    }

    private static Port[] outports;
    public static Port[] Outports {
        get {
            if (outports == null) {
                outports = PatcherDescription.outports.ToArray();
            }
            return outports;
        }
    }

    private static DataRef[] dataRefs;
    public static DataRef[] DataRefs {
        get {
            if (dataRefs == null) {
                dataRefs = PatcherDescription.externalDataRefs.ToArray();
            }
            return dataRefs;
        }
    }

    private static PresetEntry[] presets;
    public static PresetEntry[] Presets {
        get {
            if (presets == null) {
                string s = Marshal.PtrToStringAnsi(RNBOGetPresets());
                presets = JsonUtility.FromJson<PresetList>(s)!.presets.ToArray();
            }
            return presets;
        }
    }

    public static MessageTag Tag(string v) {
        IntPtr tagPtr = (IntPtr)Marshal.StringToHGlobalAnsi(v);
        var r = RNBOTag(tagPtr);
        Marshal.FreeHGlobal(tagPtr);
        return r;
    }

    //does this handle own the instance
    private IntPtr ownedInstance = (IntPtr)0;
    private bool OwnsInstance => ownedInstance != (IntPtr)0;

    private int sampleRate;
    
    public ${PLUGIN_NAME_ID}Handle() {
        int key;
        ownedInstance = RNBOInstanceCreate(out key);
        PluginKey = key;

        /*
         * XXX prepare to process?
        int bufferSize;
        int numBuffers;
        AudioSettings.GetDSPBufferSize(out bufferSize, out numBuffers);
        */

        sampleRate = AudioSettings.outputSampleRate;
        RegisterIfNeeded();
    }
    
    internal ${PLUGIN_NAME_ID}Handle(int key) {
        PluginKey = key;
    }
    
    ~${PLUGIN_NAME_ID}Handle() {
        if (OwnsInstance) {
            RNBOInstanceDestroy(ownedInstance);
        }
    }

    private bool registered = false;
    private void RegisterIfNeeded() {
        if (!registered) {
            registered = RegisterParameterEventDelegate() 
                && RegisterMessageEventDelegate() 
                && RegisterTransportEventDelegate() 
                && RegisterTempoEventDelegate() 
                && RegisterBeatTimeEventDelegate() 
                && RegisterTimeSignatureEventDelegate() 
                ;
        }
    }
    
    public int PluginKey {
        get; internal set;
    }
    
    public void Update() {
        RegisterIfNeeded();
        RNBOPoll(PluginKey);
    }

    public MillisecondTime Now {
        get => (MillisecondTime)(AudioSettings.dspTime * 1000.0);
    }

    public void Process(float[] data, int channels) {
        if (!OwnsInstance) {
            throw new InvalidOperationException("Process can only be called on owned instances");
        }

        RNBOProcess(ownedInstance, Now, data, channels, data.Length / channels, sampleRate);
    }

    public bool ResolveTag(MessageTag tag, out string tagStr) {
        IntPtr p;
        var r = RNBOResolveTag(PluginKey, tag, out p);
        if (r) {
            tagStr = Marshal.PtrToStringAnsi(p);
        } else {
            tagStr = string.Empty;
        }
        return r;
    }

    public static ParameterInfo GetParamByIndex(int index) => Array.Find(Parameters, p => p.index == index);
    public static ParameterInfo[] GetParamsByName(string name) => Array.FindAll(Parameters, p => name.Equals(p.name));
    public static ParameterInfo GetParamById(string id) => Array.Find(Parameters, p => id.Equals(p.paramId));

    private static Dictionary<string, int> parameterNameToIndex;
    public static int? GetFirstParamIndexByName(string name) {
        if (parameterNameToIndex == null) {
            parameterNameToIndex = new Dictionary<string, int>();
            foreach (var p in Parameters) {
                if (!parameterNameToIndex.ContainsKey(p.name)) {
                    parameterNameToIndex.Add(p.name, p.index);
                }
            }
        }
        int index = 0;
        if (parameterNameToIndex.TryGetValue(name, out index)) {
            return index;
        }
        return null;
    }

    private static Dictionary<string, int> parameterIdToIndex;
    public static int? GetParamIndexById(string id) {
        if (parameterIdToIndex == null) {
            parameterIdToIndex = new Dictionary<string, int>();
            foreach (var p in Parameters) {
                parameterIdToIndex.Add(p.paramId, p.index);
            }
        }
        int index = 0;
        if (parameterIdToIndex.TryGetValue(id, out index)) {
            return index;
        }
        return null;
    }

    public bool GetParamValue(int index, out ParameterValue value) {
        return RNBOGetParamValue(PluginKey, (ParameterIndex)index, out value);
    }

    public bool SetParamValue(int index, ParameterValue value, MillisecondTime attime = 0) {
        return RNBOSetParamValue(PluginKey, (ParameterIndex)index, value, attime);
    }

    public bool GetParamValueNormalized(int index, out ParameterValue value) {
        return RNBOGetParamValueNormalized(PluginKey, (ParameterIndex)index, out value);
    }

    public bool SetParamValueNormalized(int index, ParameterValue value, MillisecondTime attime = 0) {
        return RNBOSetParamValueNormalized(PluginKey, (ParameterIndex)index, value, attime);
    }

    public bool SendBang(MessageTag tag, MillisecondTime atTime = 0) {
        return RNBOSendMessageBang(PluginKey, tag, atTime);
    }

    public bool SendMessage(MessageTag tag, Float value, MillisecondTime atTime = 0) {
        return RNBOSendMessageNumber(PluginKey, tag, value, atTime);
    }

    public bool SendMessage(MessageTag tag, Float[] values, MillisecondTime atTime = 0) {
        return RNBOSendMessageList(PluginKey, tag, values, (IntPtr)values.Length, atTime);
    }

    public bool SendMIDI(byte[] data, MillisecondTime atTime = 0) {
        return RNBOSendMIDI(PluginKey, data, (IntPtr)data.Length, atTime);
    }

    public bool SendMIDINoteOn(byte channel, byte noteNum, byte velocity, MillisecondTime atTime = 0) {
        Debug.Assert(channel < (byte)16);
        Debug.Assert(noteNum < (byte)128);
        Debug.Assert(velocity < (byte)128);
        byte[] data = new byte[] { (byte)(channel | MIDIHeaders.NOTE_ON), noteNum, velocity };
        return SendMIDI(data, atTime);
    }

    public bool SendMIDINoteOff(byte channel, byte noteNum, byte velocity = (byte)0, MillisecondTime atTime = 0) {
        Debug.Assert(channel < (byte)16);
        Debug.Assert(noteNum < (byte)128);
        Debug.Assert(velocity < (byte)128);
        byte[] data = new byte[] { (byte)(channel | MIDIHeaders.NOTE_OFF), noteNum, velocity };
        return SendMIDI(data, atTime);
    }

    public bool SendMIDICC(byte channel, byte num, byte val, MillisecondTime atTime = 0) {
        Debug.Assert(channel < (byte)16);
        Debug.Assert(num < (byte)128);
        Debug.Assert(val < (byte)128);
        byte[] data = new byte[] { (byte)(channel | MIDIHeaders.CONTROL_CHANGE), num, val };
        return SendMIDI(data, atTime);
    }

    public bool SetTransportRunning(bool on, MillisecondTime atTime = 0) {
        return RNBOSendTransportEvent(PluginKey, on, atTime);
    }

    public bool SetTempo(Float val, MillisecondTime atTime = 0) {
        return RNBOSendTempoEvent(PluginKey, val, atTime);
    }

    public bool SetBeatTime(Float val, MillisecondTime atTime = 0) {
        return RNBOSendBeatTimeEvent(PluginKey, val, atTime);
    }
    
    public bool SetTimeSignature(int numerator, int denominator, MillisecondTime atTime = 0) {
        return RNBOSendTimeSignatureEvent(PluginKey, numerator, denominator, atTime);
    }

    public bool LoadDataRef(string id, float[] data, int channels, int samplerate) {
        IntPtr idPtr = (IntPtr)Marshal.StringToHGlobalAnsi(id);
        var r = RNBOCopyLoadDataRef(PluginKey, idPtr, data, (IntPtr)data.Length, (IntPtr)channels, (IntPtr)samplerate);
        Marshal.FreeHGlobal(idPtr);
        return r;
    }

    public bool ReleaseDataRef(string id) {
        IntPtr idPtr = (IntPtr)Marshal.StringToHGlobalAnsi(id);
        var r = RNBOReleaseDataRef(PluginKey, idPtr);
        Marshal.FreeHGlobal(idPtr);
        return r;
    }

    public bool LoadPreset(string payload) {
        IntPtr p = (IntPtr)Marshal.StringToHGlobalAnsi(payload);
        var r = RNBOLoadPreset(PluginKey, p);
        Marshal.FreeHGlobal(p);
        return r;
    }

    //NOTE: might cause clicks
    public bool GetPresetSync(out string payload) {
        IntPtr p;

        var r = RNBOGetPresetSync(PluginKey, out p);
        if (r) {
            payload = Marshal.PtrToStringAnsi(p);
        } else {
            payload = string.Empty;
        }
        RNBOFreePreset(p);

        return r;
    }

    //keep a reference to the callback so that it isn't garabage collected
    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate void InternalParameterEventDelegate(ParameterIndex index, ParameterValue value, MillisecondTime time);
    private InternalParameterEventDelegate registeredParameterEventDelegate;
    private bool RegisterParameterEventDelegate() {
        InternalParameterEventDelegate d = (index, value, time) => {
            var e = ParameterChangedEvent;
            if (e != null) {
                //cast to int as it is easier to use for unity
                e(this, new ParameterChangedEventArgs((int)index, value, time));
            }
        };
        var r = RNBORegisterParameterEventCallback(PluginKey, Marshal.GetFunctionPointerForDelegate(d));
        registeredParameterEventDelegate = d;
        return r;
    }

    //keep a reference to the callback so that it isn't garabage collected
    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate void InternalMessageEventDelegate(MessageTag tag, IntPtr messageType, IntPtr valuesPtr, IntPtr valueCount, MillisecondTime time);
    private InternalMessageEventDelegate registeredMessageEventDelegate;
    private bool RegisterMessageEventDelegate() {
        InternalMessageEventDelegate d = (tag, messageType, valuesPtr, valueCount, time) => {
            var e = MessageEvent;
            if (e != null) {
                MessageEventType t = MessageEventType.Bang;
                Float[] values = new Float[(int)valueCount];

                if (messageType.Equals(IntPtr.Zero)) {
                    Marshal.Copy(valuesPtr, values, 0, 1);
                    t = MessageEventType.Number;
                } else if (messageType.Equals((IntPtr)1)) {
                    Marshal.Copy(valuesPtr, values, 0, (int)valueCount);
                    t = MessageEventType.List;
                }

                e(this, new MessageEventArgs(tag, t, values, time));
            }
        };
        var r = RNBORegisterMessageEventCallback(PluginKey, Marshal.GetFunctionPointerForDelegate(d));
        registeredMessageEventDelegate = d;
        return r;
    }

    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate void InternalTransportEventDelegate(bool running, MillisecondTime time);
    private InternalTransportEventDelegate registeredTransportEventDelegate;
    private bool RegisterTransportEventDelegate() {
        InternalTransportEventDelegate d = (on, time) => {
            var e = TransportEvent;
            if (e != null) {
                e(this, new TransportEventArgs(on, time));
            }
        };
        var r = RNBORegisterTransportEventCallback(PluginKey, Marshal.GetFunctionPointerForDelegate(d));
        registeredTransportEventDelegate = d;
        return r;
    }

    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate void InternalTempoEventDelegate(Float bpm, MillisecondTime time);
    private InternalTempoEventDelegate registeredTempoEventDelegate;
    private bool RegisterTempoEventDelegate() {
        InternalTempoEventDelegate d = (value, time) => {
            var e = TempoEvent;
            if (e != null) {
                e(this, new TempoEventArgs(value, time));
            }
        };
        var r = RNBORegisterTempoEventCallback(PluginKey, Marshal.GetFunctionPointerForDelegate(d));
        registeredTempoEventDelegate = d;
        return r;
    }

    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate void InternalBeatTimeEventDelegate(Float value, MillisecondTime time);
    private InternalBeatTimeEventDelegate registeredBeatTimeEventDelegate;
    private bool RegisterBeatTimeEventDelegate() {
        InternalBeatTimeEventDelegate d = (value, time) => {
            var e = BeatTimeEvent;
            if (e != null) {
                e(this, new BeatTimeEventArgs(value, time));
            }
        };
        var r = RNBORegisterBeatTimeEventCallback(PluginKey, Marshal.GetFunctionPointerForDelegate(d));
        registeredBeatTimeEventDelegate = d;
        return r;
    }

    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate void InternalTimeSignatureEventDelegate(int numerator, int denominator,  MillisecondTime time);
    private InternalTimeSignatureEventDelegate registeredTimeSignatureEventDelegate;
    private bool RegisterTimeSignatureEventDelegate() {
        InternalTimeSignatureEventDelegate d = (numerator, denominator, time) => {
            var e = TimeSignatureEvent;
            if (e != null) {
                e(this, new TimeSignatureEventArgs(numerator, denominator, time));
            }
        };
        var r = RNBORegisterTimeSignatureEventCallback(PluginKey, Marshal.GetFunctionPointerForDelegate(d));
        registeredTimeSignatureEventDelegate = d;
        return r;
    }

    [UnmanagedFunctionPointer(CallingConvention.StdCall)]
    private delegate void TransportRequestDelegate(MillisecondTime time, out bool running, out Float bpm, out Float beatTime, out int timeSigNum, out int timeSigDenom);

    private static Transport registeredGlobalTransport;
    private static TransportRequestDelegate registeredGlobalTransportRequestDelegate;
    public static void RegisterGlobalTransport(Transport transport) {
        TransportRequestDelegate d = transport.AudioThreadUpdate;

        RNBORegisterGlobalTransportRequestCallback(Marshal.GetFunctionPointerForDelegate(d));
        registeredGlobalTransport = transport;
        registeredGlobalTransportRequestDelegate = d;
    }

    private Transport registeredTransport;
    private TransportRequestDelegate registeredTransportRequestDelegate;
    public bool RegisterTransport(Transport transport) {
        TransportRequestDelegate d = transport.AudioThreadUpdate;

        var r = RNBORegisterTransportRequestCallback(PluginKey, Marshal.GetFunctionPointerForDelegate(d));
        registeredTransport = transport;
        registeredTransportRequestDelegate = d;
        return r;
    }
}

public class ${PLUGIN_NAME_ID}Helper : MonoBehaviour {
    private static Dictionary<int, GameObject> instances = new Dictionary<int, GameObject>();
    public static ${PLUGIN_NAME_ID}Helper FindById(int key) {
        lock (instances) {
            GameObject go;
            if (!instances.TryGetValue(key, out go)) {
                go = new GameObject(String.Format("${PLUGIN_NAME_ID}HelperObject{0}", key));
                DontDestroyOnLoad(go);
                instances.Add(key, go);

                ${PLUGIN_NAME_ID}Helper helper = go.AddComponent<${PLUGIN_NAME_ID}Helper>();
                helper.Plugin = new ${PLUGIN_NAME_ID}Handle(key);
                return helper;
            }
            return go.GetComponent<${PLUGIN_NAME_ID}Helper>();
        }
    }

    public ${PLUGIN_NAME_ID}Handle Plugin {
        get; internal set;
    }

    public int PluginKey {
        get => Plugin?.PluginKey ?? 0;
    }

    public void Update() {
        if (Plugin != null)
            Plugin.Update();
    }
}
